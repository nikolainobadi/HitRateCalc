name: CI

on:
  pull_request:
    branches: [ main, release-* ]

jobs:
  build-and-test :
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Select Xcode
      run: sudo xcode-select -switch /Applications/Xcode_14.2.app

    - name: Get Product Name
      run: |
        set -euo pipefail
        SCHEME="$(xcodebuild -list -json | jq -r '.project.schemes[0]')"
        PRODUCT_NAME="$(xcodebuild -scheme "$SCHEME" -showBuildSettings | grep " PRODUCT_NAME " | sed "s/[ ]*PRODUCT_NAME = //")"
        echo "PRODUCT_NAME=$PRODUCT_NAME" >> $GITHUB_ENV

    - name: Build and test
      run: xcodebuild clean build test -project "$PRODUCT_NAME.xcodeproj" -scheme $SCHEME -destination "platform=iOS Simulator,name=iPhone 13,OS=15.5" ONLY_ACTIVE_ARCH=NO CODE_SIGNING_REQUIRED=NO -quiet
